# åŸºäºPythonçš„æ•°æ®åº“å®ç°

# 1.éœ€æ±‚åˆ†æ

## 1.1 æ¦‚è¿°

ä»åº•å±‚åšèµ·ï¼Œå®ç°æ•°æ®åº“çš„ç»„ç»‡ã€å­˜å‚¨ã€æ£€ç´¢ã€æ›´æ–°å’Œç´¢å¼•ç­‰åŠŸèƒ½ã€‚

## 1.2 åŸºæœ¬åŠŸèƒ½

- è®¾è®¡ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨æ•°æ®è¡¨ã€è§†å›¾ã€ç´¢å¼•ä¸‰ç§æ•°æ®åº“å¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå»ºç«‹æ•°æ®åº“ç³»ç»Ÿçš„æ•°æ®å­—å…¸

- è®¾è®¡ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨æ•°æ®è¡¨ä¸­çš„æ•°æ®

- è®¾è®¡ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨ç´¢å¼•æ•°æ®

- è®¾è®¡ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ç”¨äºå­˜å‚¨ç”¨æˆ·å’Œè®¿é—®æƒé™çš„ä¿¡æ¯

- è¾“å…¥â€œhelp databaseâ€å‘½ä»¤ï¼Œè¾“å‡ºæ‰€æœ‰æ•°æ®è¡¨ã€è§†å›¾å’Œç´¢å¼•çš„ä¿¡æ¯ï¼ŒåŒæ—¶æ˜¾ç¤ºå…¶å¯¹è±¡ç±»å‹ï¼›è¾“å…¥â€œhelp table è¡¨åâ€å‘½ä»¤ï¼Œè¾“å‡ºæ•°æ®è¡¨ä¸­æ‰€æœ‰å±æ€§çš„è¯¦ç»†ä¿¡æ¯ï¼›è¾“å…¥â€œhelp view è§†å›¾åâ€å‘½ä»¤ï¼Œè¾“å‡ºè§†å›¾çš„å®šä¹‰è¯­å¥ï¼›è¾“å…¥â€œhelp index ç´¢å¼•åâ€å‘½ä»¤ï¼Œè¾“å‡ºç´¢å¼•çš„è¯¦ç»†ä¿¡æ¯

- è§£æCREATEã€SELECTã€INSERTã€DELETEã€UPDATEç­‰SQLè¯­å¥çš„å†…å®¹ï¼›æ£€æŸ¥SQLè¯­å¥ä¸­çš„è¯­æ³•é”™è¯¯å’Œè¯­ä¹‰é”™è¯¯

- æ‰§è¡ŒCREATEè¯­å¥ï¼Œåˆ›å»ºæ•°æ®è¡¨ã€è§†å›¾ã€ç´¢å¼•ä¸‰ç§æ•°æ®åº“å¯¹è±¡ï¼›åˆ›å»ºæ•°æ®è¡¨æ—¶éœ€è¦åŒ…å«ä¸»ç å¤–ç ã€å”¯ä¸€æ€§çº¦æŸã€éç©ºçº¦æŸç­‰å®Œæ•´æ€§çº¦æŸçš„å®šä¹‰

- æ‰§è¡ŒSELECTè¯­å¥ï¼Œä»è‡ªä¸»è®¾è®¡çš„æ•°æ®è¡¨ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå¹¶è¾“å‡ºç»“æœï¼›åœ¨SELECTè¯­å¥ä¸­éœ€è¦æ”¯æŒGROUP BYã€HAVINGå’ŒORDER BYå­å¥ï¼Œéœ€è¦æ”¯æŒ5ç§èšé›†å‡½æ•°

- æ‰§è¡ŒINSERTã€DELETEå’ŒUPDATEè¯­å¥ï¼Œæ›´æ–°æ•°æ®è¡¨çš„å†…å®¹ï¼›æ›´æ–°è¿‡ç¨‹ä¸­éœ€è¦æ£€æŸ¥æ›´æ–°åçš„æ•°æ®è¡¨æ˜¯å¦ä¼šè¿åå‚ç…§å®Œæ•´æ€§çº¦æŸã€‚å¦‚æœæ˜¯ï¼Œåˆ™æç¤ºè¿åå“ªä¸€æ¡å®Œæ•´æ€§çº¦æŸï¼Œå¹¶æ‹’ç»æ‰§è¡Œæ›´æ–°æ“ä½œï¼›å¦‚æœå¦ï¼Œæç¤ºæ•°æ®è¡¨æ›´æ–°æˆåŠŸï¼Œå¹¶è¯´æ˜æ’å…¥ã€åˆ é™¤æˆ–ä¿®æ”¹äº†å‡ ä¸ªå…ƒç»„

- å½“æ•°æ®è¡¨çš„å†…å®¹æ›´æ–°åï¼Œæ ¹æ®ç´¢å¼•çš„å®šä¹‰ï¼Œè‡ªåŠ¨æ›´æ–°ç´¢å¼•è¡¨çš„å†…å®¹

- åœ¨æœ‰ç´¢å¼•çš„æ•°æ®è¡¨ä¸Šæ‰§è¡ŒæŸ¥è¯¢è¯­å¥æ—¶ï¼Œé¦–å…ˆåˆ©ç”¨ç´¢å¼•æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„å…ƒç»„æŒ‡é’ˆï¼Œç„¶åé€šè¿‡æŒ‡é’ˆåˆ°æ•°æ®è¡¨ä¸­å–å‡ºç›¸åº”çš„å…ƒç»„

- æ‰§è¡ŒGRANTè¯­å¥ï¼Œä¸ºç”¨æˆ·æˆäºˆå¯¹æŸæ•°æ®åº“å¯¹è±¡çš„SELECTã€INSERTã€DELETEã€UPDATEç­‰æƒé™ï¼›æ‰§è¡ŒREVOKEè¯­å¥ï¼Œæ”¶å›ä¸Šè¿°æƒé™

- ç”¨æˆ·ç™»å½•æ—¶ï¼Œéœ€è¦è¾“å…¥ç”¨æˆ·åï¼›å¦‚æœç”¨æˆ·æ²¡æœ‰è¢«æˆæƒï¼Œåˆ™æ‹’ç»æ‰§è¡Œç”¨æˆ·æŸ¥è¯¢æˆ–æ›´æ–°ç­‰æ“ä½œï¼Œå¹¶ç»™å‡ºæç¤ºä¿¡æ¯

- å°†SELECTè¯­å¥è½¬åŒ–ä¸ºå…³ç³»ä»£æ•°è¡¨è¾¾å¼ï¼Œå†åˆ©ç”¨æŸ¥è¯¢ä¼˜åŒ–ç®—æ³•å¯¹å…³ç³»ä»£æ•°è¡¨è¾¾å¼è¿›è¡Œä¼˜åŒ–ï¼Œè¾“å‡ºä¼˜åŒ–åçš„å…³ç³»ä»£æ•°è¡¨è¾¾å¼æˆ–SELECTè¯­å¥

## 1.3 ç³»ç»Ÿéœ€æ±‚

- å¼€å‘è¯­è¨€ï¼šPython

- å¼€å‘å·¥å…·ï¼šPycharm

# 2.æ¦‚è¦è®¾è®¡è¯´æ˜

## 2.1 æ•°æ®æ–‡ä»¶å­˜å‚¨

è®¾ç½®systemåº“ï¼Œtable_informationåº“ï¼Œviewåº“ä¸ºç³»ç»Ÿåˆå§‹åŒ–åå»ºç«‹çš„åˆå§‹æ•°æ®åº“ã€‚æ–‡ä»¶ä½¿ç”¨excelå­˜å‚¨ã€‚

## 2.2 æ¨¡å—åŠŸèƒ½åŠæè¿°

### 2.1.1 runå‡½æ•°æ¨¡å—

runå‡½æ•°æ¨¡å—æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å…¥å£ï¼Œæœ¬æ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆå§‹åŒ–ç”¨æˆ·ï¼Œè°ƒç”¨å„æ¨¡å—ï¼Œå¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œå®ç°æ•°æ®åº“ç®¡ç†åŠŸèƒ½ã€‚

### 2.1.2 ç”¨æˆ·éªŒè¯åŠç™»å½•æ¨¡å—

æœ¬æ¨¡å—åŠŸèƒ½æ˜¯è¿›è¡Œç”¨æˆ·çš„ç™»å½•è®¤è¯ã€‚

### 2.1.3 åˆ›å»ºè¡¨æ¨¡å—

æ ¹æ®æ ‡å‡† SQL è¯­è¨€å°†è¾“å…¥è¯­å¥è¿›è¡Œåˆ†å‰²ï¼Œè·å¾—è¡¨åï¼Œå„ä¸ªå±æ€§åï¼Œå±æ€§ç±»å‹ï¼Œçº¦æŸæ¡ä»¶ç­‰å†…å®¹ï¼Œå†è¿›è¡Œè¡¨çš„åˆ›å»ºã€‚

### 2.1.4 åˆ›å»ºè§†å›¾æ¨¡å—

æœ¬æ¨¡å—é€šè¿‡ CREATE VIEW VIEW_NAME AS SELECT â€¦è¯­å¥æ¥åˆ›å»ºè§†å›¾ï¼Œå°†å­˜å‚¨è§†å›¾å’Œå¯¹åº”çš„è¯­å¥ã€‚

### 2.1.5 æ’å…¥æ•°æ®æ¨¡å—

å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®å­˜å…¥ç›¸åº”çš„è¡¨ä¸­å¹¶è¿›è¡Œçº¦æŸæ£€æŸ¥ã€‚

### 2.1.6 æ›´æ–°æ•°æ®æ¨¡å—

æ ¹æ®ç”¨æˆ·çš„ WHERE æ¡ä»¶æ›´æ–°ç¬¦åˆæ¡ä»¶çš„å…ƒç»„å¹¶è¿›è¡Œçº¦æŸæ£€æŸ¥ã€‚

### 2.1.7 æŸ¥è¯¢æ•°æ®æ¨¡å—

æ ¹æ®ç”¨æˆ·çš„æŸ¥è¯¢æ¡ä»¶è¿›è¡ŒæŸ¥è¯¢ã€‚

### 2.1.8 åˆ é™¤æ•°æ®æ¨¡å— 

æ ¹æ®ç”¨æˆ·çš„ WHERE æ¡ä»¶åˆ é™¤ç¬¦åˆæ¡ä»¶çš„å…ƒç»„ã€‚

### 2.1.9 å¸®åŠ©æ¨¡å— 

- HELP DATABASE å¯æŸ¥çœ‹å½“å‰æ•°æ®åº“ä¸‹çš„æ‰€æœ‰çš„è¡¨ï¼Œè§†å›¾ä¿¡æ¯

- help table è¡¨åå¯è¾“å‡ºæ•°æ®è¡¨ä¸­æ‰€æœ‰å±æ€§çš„è¯¦ç»†ä¿¡æ¯

- è¾“å…¥â€œhelp view è§†å›¾åâ€å‘½ä»¤ï¼Œè¾“å‡ºè§†å›¾çš„å®šä¹‰è¯­å¥

- è¾“å…¥â€œhelp index ç´¢å¼•åâ€å‘½ä»¤ï¼Œè¾“å‡ºç´¢å¼•çš„è¯¦ç»†ä¿¡æ¯

### 2.1.10 æˆæƒä¸æƒé™æ”¶å›æ¨¡å— 

é€šè¿‡grantå’Œrevorkå®ç°ç”¨æˆ·å¯¹è¡¨å’Œè§†å›¾çš„ CREATEã€DELETEã€UPDATEã€INSERT å››ç§æ“ä½œçš„æƒé™æˆäºˆä¸æ”¶å›ã€‚

### 2.1.11 ç´¢å¼•å»ºç«‹å’Œæ›´æ–°æ¨¡å—

ä½¿ç”¨createè¯­å¥å»ºç«‹ç´¢å¼•ï¼Œåœ¨å†…å®¹æ›´æ–°åæ›´æ–°ç´¢å¼•ã€‚

## 2.3 æ¨¡å—è°ƒç”¨å›¾

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/75ce3ad05a8e626aaa288ac97a08b69b.writebug)

# 3.è¯¦ç»†è®¾è®¡è¯´æ˜

## 3.1 ç¯å¢ƒä¾èµ–

æœ¬ç¨‹åºç”¨åˆ°çš„åº“ï¼š

``python
from openpyxl import *
import  os
import re
from index import *
from prettytable import PrettyTable
import hashlib
import bisect
import Queue
```

## 3.2 æ•°æ®å­˜å‚¨

æ•°æ®åº“çš„æ•°æ®ä½¿ç”¨xlsxæ ¼å¼å­˜å‚¨ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªæ•°æ®åº“ï¼Œå·¥ä½œç°¿å¯¹åº”åº“ä¸­çš„è¡¨ï¼Œè¡¨ç»“æ„å’Œæ–‡ä»¶ç»“æ„å¯¹åº”ã€‚

ç´¢å¼•ä½¿ç”¨æ–‡æœ¬å­˜å‚¨dictã€‚

ä½¿ç”¨openpyxlåº“è¿›è¡Œæ–‡ä»¶å†…å®¹çš„æ“ä½œã€‚

æ•°æ®åº“ç¤ºä¾‹ï¼š

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/64b732a811ea7841b5cbf99977a9f3df.writebug)

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/d6361cda807da8f600f7a4bef56d2e9e.writebug)

## 3.3 runå‡½æ•°çš„åŠŸèƒ½

â€‹```python
* ç¨‹åºåˆå§‹åŒ–
* æ‰“å°æ¬¢è¿è¯­å¥
* å¤„ç†ç”¨æˆ·ç™»å½•ä¸è®¤è¯
* å¤„ç†å¸®åŠ©å‘½ä»¤å’Œé€€å‡ºå‘½ä»¤

def run():
    Initialization()
    welcome()
    login()
    while True:
        command = get_command()
        #print command
        if command == 'quit' or command == 'exit':
            print("[ğŸ»] Thanks for using L-DBMS. Bye~~")
            exit(0)
        elif command == 'help':
            help()
        else:
            query(command)
```

## 3.3 åˆå§‹åŒ–å‡½æ•°çš„åŠŸèƒ½

```python
* åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•
* åˆ›å»ºç³»ç»Ÿæ•°æ®åº“æ–‡ä»¶
* åˆ›å»ºç³»ç»Ÿç”¨æˆ·
* èµ‹äºˆç³»ç»Ÿç”¨æˆ·æƒé™

def Initialization():
    if not os.path.exists(db_path):
        os.mkdir(db_path)
    if not os.path.exists("data/table_information.xlsx"):
        Workbook().save("data/table_information.xlsx")
    if os.path.exists("data/system.xlsx"):
        print "Initializating......"
    else:
        creat_db('system')
    db = load_workbook("data/system.xlsx")
    permission_tb_col = ['database char[50] pk unique','select char','insert char','delete char','update char']
creat_table('permission', db, 'system',permission_tb_col)
```

**ç›®å½•ç»“æ„**

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/091e9a260756ea6512c5b5b3456624c3.writebug)

## 3.4 ç”¨æˆ·éªŒè¯åŠç™»å½•æ¨¡å—

**ç™»é™†å¤„ç†**

é€šè¿‡raw_input()å‡½æ•°è·å–ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œäº¤ç»™check_login()å‡½æ•°æ¥éªŒè¯æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœchecké€šè¿‡ï¼Œè¾“å‡ºæ¬¢è¿ç•Œé¢å¹¶å°†å…¨å±€å˜é‡userèµ‹å€¼ã€‚

```python
def login():
    global user
    print "Please Login:"
    username = raw_input("username: ")
    password = raw_input("password: ")
    if check_login(username,password):
        print "Login Success!Welcome {}! ğŸ˜Š".format(username)
        user = username
    else:
        print "user not exist or password is wrong!ğŸ˜£ Try again."
        login()
```

check_loginå‡½æ•°é€šè¿‡è¾“å…¥çš„usernameæŸ¥è¯¢æ•°æ®åº“ä¸­å¯¹åº”çš„å¯†ç ï¼Œå°†æŸ¥è¯¢ç»“æœå’Œç”¨æˆ·è¾“å…¥çš„å€¼çš„md5åŠ å¯†å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸€è‡´ï¼Œè®¤ä¸ºæˆåŠŸç™»é™†ã€‚
å¦‚æœå¯†ç ä¸æ­£ç¡®æˆ–æ— æ­¤ç”¨æˆ·ï¼Œéƒ½è¾“å‡ºerrorå¹¶è¦æ±‚ç”¨æˆ·å†ä¸€æ¬¡è¾“å…¥

```python
def check_login(username,password):
    db = load_workbook("data/system.xlsx")
    #right_pswd = select(password,user,{'username':username})
    table = db['user']
    col_list = list(iter_cols(table))
    try:
        pos = col_list[0].index(username)
    except:
        return False
    right_pswd = col_list[1][pos]
    if hashlib.md5(password).hexdigest() == right_pswd:
        return True
    else:
        return False
```

**ç™»é™†æ•ˆæœ**

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/bbbbf6bfdc6e3fd5a3446a594ccd4291.writebug)

## 3.5 åˆ›å»ºè¡¨æ¨¡å—

**è¯­å¥**

```sql
create table tbname (id int PK null,user char[10] )
```

åœ¨åˆ›å»ºæ—¶å°†çº¦æŸå†™å…¥table_informationè¡¨ä¸­ã€‚

```python
def creat_table(table_name,current_database,current_dbname,columns_list):
    # create table
    if table_name not in current_database.sheetnames:
        table = current_database.create_sheet(table_name)
    else:
        print (u"æ•°æ®è¡¨å·²å­˜åœ¨,è¯·é‡æ–°è¾“å…¥.")
        return
    if current_database.worksheets[0].title == 'Sheet':
        del current_database['Sheet']
    #è¡¨åˆ›å»ºå®Œæˆï¼Œå¼€å§‹åˆ›å»ºåˆ—
    length = len(columns_list)
    #print length
    tbinfo = load_workbook("data/table_information.xlsx")
    tbinfo_tb = tbinfo[current_dbname]
    tbinfo_rows = tbinfo_tb.max_row
    column_names = []
    for i in range(length):             #å°†å­—æ®µçš„å±æ€§å†™åˆ°table_informationåº“ä¸­
        column = columns_list[i].split(' ')
        tbinfo_tb.cell(row=tbinfo_rows+1+i,column=1).value = table_name
        tbinfo_tb.cell(row=tbinfo_rows+1+i, column=2).value = column[0]
        tbinfo_tb.cell(row=tbinfo_rows+1+i, column=3).value = column[1]
        for key in column[2:]:
            if key == 'null':
                tbinfo_tb.cell(row=tbinfo_rows + 1 + i, column=4).value = '1'
            elif key == 'not_null':
                tbinfo_tb.cell(row=tbinfo_rows + 1 + i, column=4).value = '0'
            elif key == 'unique':
                tbinfo_tb.cell(row=tbinfo_rows + 1 + i, column=5).value = '1'
            elif key == 'pk':
                tbinfo_tb.cell(row=tbinfo_rows + 1 + i, column=6).value = '1'
            elif key == 'fk':
                tbinfo_tb.cell(row=tbinfo_rows + 1 + i, column=7).value = '1'
        column_names.append(column[0])
        for j in range(1, 8):
            if tbinfo_tb.cell(row=tbinfo_rows + 1 + i, column=j).value is None:
                tbinfo_tb.cell(row=tbinfo_rows + 1 + i, column=j).value = 'NULL'
    tbinfo.save("data/table_information.xlsx")
    for i in range(length):
        table.cell(row=1,column=i+1).value = column_names[i]  #è¡¨ç¬¬ä¸€è¡Œæ˜¯åˆ—å
    current_dbname = db_path + current_dbname + '.xlsx'
    current_database.save(current_dbname)
print (u"æ•°æ®è¡¨åˆ›å»ºå®Œæˆã€‚")
```

**table_informationè¡¨ï¼ˆæµ‹è¯•æ•°æ®ï¼‰**

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/8d42cfe25b75f43f20e5543032f8c932.writebug)

## 3.6 åˆ›å»ºè§†å›¾æ¨¡å—

**è¯­å¥**

```sql
creat view view_name as select xx from xx
```

è§£ææŸ¥è¯¢è¯­å¥ï¼Œå°†ç»“æœå­˜åœ¨viewåº“ä¸­ï¼Œæ¯ä¸€ä¸ªè§†å›¾å·²è§†å›¾åä½œä¸ºè¡¨åå†™å…¥viewåº“ä¸­ï¼Œåœ¨viewåº“ä¸­è®¾ç½®ä¸€ä¸ªsqlè¡¨åŸæ¥å­˜å‚¨è§†å›¾å’Œå¯¹åº”çš„sqlè¯­å¥ã€‚

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/e1de121c0d7655981b31576cf432d7ce.writebug)

```python
def view(viewname,sql):
    """
    file = view_path + viewname
    view = query(sql,'view')
    f = open(file, "w")
    f.write(str(view))
    f.close()
    print "Success"
    """
    db = load_workbook("data/view.xlsx")
    if viewname not in db.sheetnames:
        table = db.create_sheet(viewname)
    else:
        print ("view is exist.")
        return
    if db.worksheets[0].title == 'Sheet':
        del db['Sheet']
    sql_table = db['sql']
    maxrow = sql_table.max_row  #åœ¨sqlè¡¨ä¸­å­˜viewåå’Œå¯¹åº”çš„sqlè¯­å¥
    sql_table.cell(row=maxrow + 1, column = 1).value = viewname
    sql_table.cell(row=maxrow + 1, column = 2).value = sql
    table = db[viewname]
    views = query(sql, 'view')
    for i in range(len(views)):
        for j in range(len(views[i])):
            table.cell(row=i+1, column=j+1).value = views[i][j]
db.save("data/view.xlsx")
```

## 3.7 æ’å…¥æ¨¡å—

æ”¯æŒå•ç»„å’Œå¤šç»„çš„æ’å…¥ï¼Œå•ç»„çš„æ’å…¥å¤„ç†å°±æ˜¯å°†sqlè¯­å¥ä¸­çš„è¦æ’å…¥çš„æ•°æ®å¤„ç†æˆå­—å…¸ï¼Œå†äº¤ç»™insertå‡½æ•°å¤„ç†ã€‚

å¤šç»„çš„è¯å°†æ¯ç»„å­—å…¸åŠ å…¥æ•°ç»„å†è¿›è¡Œå¤„ç†ã€‚åœ¨æ’å…¥æ•°æ®å‰é€šè¿‡check_Constraintå‡½æ•°è¿›è¡Œçº¦æŸæ£€æŸ¥ï¼Œæ³¨é‡Šéƒ¨åˆ†æ˜¯ç”¨æ¥å¤„ç†åµŒå¥—è¯­å¥çš„ï¼Œé€»è¾‘æ˜¯é€šè¿‡æ­£åˆ™å–å‡ºå…¶ä¸­çš„å­æŸ¥è¯¢è¯­å¥ï¼Œå¸¦ä¸Štagå‚æ•°äº¤ç»™queryå‡½æ•°å¤„ç†ï¼Œå°†ç»“æœä»¥æ•°ç»„å½¢å¼è¿”å›ã€‚å› ä¸ºå¯¹è¡¨çš„æ“ä½œä¹Ÿæ˜¯å…ˆè½¬åŒ–æˆæ•°ç»„ï¼Œè¿™æ ·ç›´æ¥å¤„ç†æ•°ç»„å°±okã€‚

```python
def insert(table_name, current_database, current_dbname, columns_list):
    if not check_Constraint(columns_list,table_name):    #columnsåº”ä¸º[dict]
        print "Constraint Error"
        return False
    table = current_database[table_name]
    for columns in columns_list:
        table_rows = table.max_row
        table_columns = table.max_column
        length = len(columns)
        # print length
        for i in range(length):
            column = re.search('\((.*?)\)', columns[i], re.S).group(1)
            column_list = column.split(',')
            chk_len = len(column_list)
            if chk_len != table_columns:
                print ('æ’å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥çš„æ•°æ®æ•°é‡æ˜¯å¦ä¸åˆ—æ•°é‡å¯¹åº”ã€‚')
                return

            else:
                for j in range(chk_len):
                    table.cell(row=table_rows + i + 1, column=j + 1).value = column_list[j]
                current_dbname = db_path + current_dbname + '.xlsx'
                current_database.save(current_dbname)
                print ("æ•°æ®æ’å…¥å®Œæˆã€‚")


def check_Constraint(columns,tablename):    #columns={'a':'xx'}
    db = load_workbook("system/table_information.xlsx")
    table = db[using_dbname]
    rows = []
    rows_list = list(iter_rows(table))  #æ‰€æœ‰è¡Œ
    cols_list = list(iter_cols(table))
    for col in columns:
        value = columns[col]
        for i in range(len(cols_list[0])):  #tableå¯¹åº”çš„è¡Œ
            if cols_list[0][i] == tablename:
                rows.append(i)
        for line in rows:
            if rows_list[line][1] == col:
                typee, is_null, unique, pk, fk = rows_list[line][2:]
                if is_null == '0':
                    if value == '':
                        return False
                if unique == '1':
                    if not check_unique(tablename,col,value):
                        return False
                if pk == '1':
                    if not check_unique(tablename,col,value) or value == '':
                        return False
                if '[' in typee:
                    typee, maxlen = re.findall('(\w*)\[(\d*)\]',type) #int[10] => int,10
                else:
                    maxlen = 1000
                if len(value) > maxlen:
                    return False
                if typee == 'int':
                    if type(value) != type(1):
                        return False
                if typee == 'char':
                    if type(value) != type('c'):
                        return False
```

## 3.8 æ›´æ–°æ•°æ®

æ”¯æŒå•ç»„å’Œå¤šç»„çš„æ›´æ–°ï¼Œå•ç»„çš„æ›´æ–°å¤„ç†å°±æ˜¯å°†sqlè¯­å¥ä¸­çš„è¦æ’å…¥çš„æ•°æ®å¤„ç†æˆå­—å…¸ï¼Œå†äº¤ç»™insertå‡½æ•°å¤„ç†ã€‚

å¤šç»„çš„è¯å°†æ¯ç»„å­—å…¸åŠ å…¥æ•°ç»„å†è¿›è¡Œå¤„ç†ã€‚åœ¨æ›´æ–°æ•°æ®å‰é€šè¿‡check_Constraintå‡½æ•°è¿›è¡Œçº¦æŸæ£€æŸ¥ï¼Œå…¶ä»–åŠŸèƒ½å’Œinsertçš„é€»è¾‘ä¸€æ ·ã€‚

**è¯­å¥**

```sql
UPDATE table_name SET column1=value1,column2=value2,... WHERE some_column=some_value;
```

```python
def update(table_name,current_database,current_dbname,columns_list,update_columns_list):
    if not check_Constraint(update_columns_list,table_name):    #columnsåº”ä¸ºdict
        print "Constraint Error"
        return False
    table = current_database[table_name]
    table_rows = table.max_row  # è¡Œ
    table_columns = table.max_column  # åˆ—
    length = len(columns_list)
    update_row_num = [x for x in range(2,table_rows+1)]
    columns_name = []
    for cell in list(table.rows)[0]:
        columns_name.append(cell.value)
    for key in columns_list:
        flag = 0
        for i in range(len(columns_name)):  # åˆ¤æ–­colmuns_list æ˜¯å¦æœ‰ not in colmusä¸­çš„
            if columns_name[i] == key:
                flag = 1
        if flag == 0:  # è¾“å…¥çš„åˆ—åä¸å­˜åœ¨
            print("Unknown column '{}' in 'where clause'".format(key))
            return
    for key in columns_list:
        column_num = columns_name.index(key)
        for i in update_row_num[::-1]:  #å€’ç€æ¥
            if table.cell(row=i, column=column_num+1).value != columns_list[key]:
                update_row_num.remove(i)
    if len(update_row_num) > 0:
        for i in update_row_num[::-1]:
            for j in range(1,table_columns+1):
                clu_name = table.cell(row=1, column=j).value
                table.cell(row=i, column=j).value = update_columns_list[clu_name]
    else:
        print("find 0 to update.")
    current_database.save(db_path + current_dbname + '.xlsx')
print("æ›´æ–°å®Œæˆï¼Œå½±å“{}è¡Œ".format(len(update_row_num)))
```

## 3.9 è¯­å¥å¤„ç†å‡½æ•°

```python
* qlè¯­å¥çš„å¤„ç†ä¸è§£æã€‚
* é€šè¿‡åˆ‡è¯å’Œæ­£åˆ™æ¥è½¬åŒ–æ•°æ®å’Œè°ƒç”¨å„å‡½æ•°ã€‚
* é€šè¿‡splitå°†è¯­å¥æŒ‰ç…§ç©ºæ ¼åˆ‡æˆæ•°ç»„ï¼Œå…ˆæ ¹æ®é¦–è¯åˆ¤æ–­æ“ä½œå†ç»†åˆ†ã€‚
* tagå‚æ•°æ˜¯ä¸ºinsertï¼Œviewç­‰å‡½æ•°éœ€è¦ç”¨åˆ°æŸ¥è¯¢ç»“æœä½†ä¸è¾“å‡ºæ˜¯çš„æ ‡è¯†ï¼Œå¦‚æœå¸¦ç€è¯¥å‚æ•°è°ƒç”¨selectå‡½æ•°ï¼Œä¸ä¼šæ‰“å°ç»“æœè€Œæ˜¯å°†ç»“æœä»¥æ•°ç»„è¿”å›ã€‚
* selectæ“ä½œçš„è°“è¯é€šè¿‡predicateå’Œsymbolå‚æ•°æ¥æ ‡è¯†ï¼Œå¸¦ç€è¿™ä¸¤ä¸ªå‚æ•°è°ƒç”¨selectå‡½æ•°ï¼Œå…·ä½“å‚è§selectæ¨¡å—
* å¦‚æœéƒ½æ²¡åŒ¹é…æœ€åä¼šè¾“å‡ºé”™è¯¯

def query(sql,tag=''):
    sql_word = sql.split(" ")
    if len(sql_word) < 2:
        print "[!] Wrong query!"
        return
    operate = sql_word[0].lower()
    if operate == 'use':
        if sql_word[1] == 'database':
            try:
                use_db(sql_word[2])
            except:
                print "[!]Error"
        else:
            print "[!]Syntax Error.\neg:>use database dbname"
    elif operate == 'create':
        if sql_word[1] == 'database':
            try:
                creat_db(sql_word[2])
            except:
                print "[!]Create Error"
        elif sql_word[1] == 'table':
            columns_list = re.findall('\((.*)\)', sql)[0].split(',')
            print columns_list, using_dbname
            try:
                creat_table(sql_word[2], using_db, using_dbname, columns_list)
            except:
                print "[!]Error"
        elif sql_word[1] == 'view': #creat view test1 as select * from user
            viewname = sql_word[2]
            sql = ' '.join(sql_word[4:])
            view(viewname,sql)

        elif sql_word[1] == 'index':
            return
        else:
            print "[!]Syntax Error."
    elif operate == 'select':
        pos = 0
        for i in range(len(sql_word)):
            if '(' in sql_word[i] and 'select' in sql_word[i]:
                pos = i
        if pos == 3:
            sql2 = sql_word[3][1:-1]
            query(sql2,tag='nesting')
            sql_word[3] = 'tmp'
            sql = ' '.join(sql_word)



        columns = sql_word[1]
        table_name = sql_word[3]
        if len(sql_word) > 4:
            #try:
            limit = sql_word[5].split()
            predicate = 'and'
            symbol = '='
            if ',' in sql_word[5]:
                limit = sql_word[5].split(',')
                predicate = 'and'
            elif '|' in sql_word[5]:
                limit = sql_word[5].split('|')
                predicate = 'or'
            elif '>' in sql_word[5]:
                #limit = sql_word[5].split()
                symbol = '>'
            elif '<' in sql_word[5]:
                #limit = sql_word[5].split()
                symbol = '<'
            elif len(sql_word) > 6:
                if sql_word[6] == 'in':
                    limit = [sql_word[5] + '=' + sql_word[7]]
                    predicate = 'in'
                if sql_word[6] == 'like':
                    limit = [sql_word[5] + '=' + sql_word[7]]
                    predicate = 'like'
            #except:
                #limit = [].append(sql_word[5])
            #print limit
            for i in range(len(limit)):
                limit[i] = limit[i].split(symbol)
            limit = dict(limit)
            return select(columns, table_name, limit, predicate=predicate, symbol=symbol, tag=tag)
        else:   #æ²¡whereçš„æƒ…å†µ
            return select(columns, table_name, tag=tag)
    elif operate == 'grant':
        set_permission(sql_word[5], sql_word[3], sql_word[1])
    elif operate == 'revoke':
        del_permission(sql_word[5], sql_word[3], sql_word[1])
    elif operate == 'insert':   #INSERT INTO table_name col1=val1,col2=val2&col3=val3,col4=val4
        table_name = sql_word[2]
        columns_list = []
        if '&' in sql:
            cols = sql_word[3].split('&')   #[{xx},{xx}] å¤šç»„
            for p in range(len(cols)):
                col = cols[p]
                c = col.split(',')
                for i in range(len(c)):
                    c[i] = c[i].split('=')
                cols[p] = dict(c)
            columns_list = cols
        else:
            cols = sql_word[3].split(',')
            for i in range(len(cols)):
                cols[i] = cols[i].split('=')
            columns_list.append(dict(cols))
        insert(table_name,using_db,using_dbname,columns_list)
    elif operate == 'update':
        return
    elif operate == 'help':
        if sql_word[1] == 'database':
            show_db()
        if sql_word[1] == 'table':
            usdbnm = using_dbname
            use_db('table_information')
            tbname = sql_word[2]
            select('*',usdbnm,{'table':tbname})
        if sql_word[1] == 'view':
            view_name = sql_word[2]
            use_db('view')
            select('sql','sql',{'viewnamw':view_name})
        if sql_word[1] == 'index':
            print "All Index:"
            indexs = os.listdir('data/index/')  # ç¬¬äºŒç§æ–¹æ³•ï¼Œä»ä¿å­˜æ•°æ®åº“ä¿¡æ¯çš„åº“ä¸­æŸ¥è¯¢
            for index in indexs:
                if '.DS' not in index:
                    print "[*] " + index[:-5]
    else:
        print "[!]Syntax Error."
```

## 3.10 åˆ é™¤æ¨¡å—

ä¼šå…ˆcheckç”¨æˆ·æƒé™å†è¿›è¡Œæ“ä½œã€‚å…¶ä»–é€»è¾‘ç±»ä¼¼insertå‡½æ•°ã€‚

```python
def delect(table_name,current_database,current_dbname,columns_list):  #columns_list={'name1':'value1','name2':'value2'}

    table = current_database[table_name]
    table_rows = table.max_row  #è¡Œ
    table_columns = table.max_column    #åˆ—
    length = len(columns_list)
    delect_row_num = [x for x in range(2,table_rows+1)]
    columns_name=[]
    for cell in list(table.rows)[0]:
        columns_name.append(cell.value)
    for key in columns_list:
        flag = 0
        for i in range(len(columns_name)):    #åˆ¤æ–­colmuns_list æ˜¯å¦æœ‰ not in colmusä¸­çš„
            if columns_name[i] == key:
                flag = 1
        if flag == 0:   #è¾“å…¥çš„åˆ—åä¸å­˜åœ¨
            print("Unknown column '{}' in 'where clause'".format(key))
            return
    for key in columns_list:
        column_num = columns_name.index(key)
        for i in delect_row_num[::-1]:  #å€’ç€æ¥
            if table.cell(row=i, column=column_num+1).value != columns_list[key]:
                delect_row_num.remove(i)
    if len(delect_row_num) > 0:
        for i in delect_row_num[::-1]:
            #print i,table_rows
            table.delete_rows(int(i))
    else:
        print("find 0 to delect.")
    current_database.save(db_path + current_dbname + '.xlsx')
print("åˆ é™¤å®Œæˆï¼Œå½±å“{}è¡Œ".format(len(delect_row_num)))
```

### 3.11 æƒé™æ£€æŸ¥æ¨¡å—

åœ¨ç”¨æˆ·å¯¹æŸå¯¹è±¡è¿›è¡Œæ“ä½œä¹‹å‰ç¡®å®šè¯¥ç”¨æˆ·æœ‰æ²¡æœ‰æ“ä½œæƒé™ã€‚ç”¨æˆ·å¯¹å¯¹è±¡çš„æ“ä½œæƒé™å­˜å‚¨åœ¨systemåº“ä¸­çš„permissionè¡¨ï¼Œåœ¨ç”¨æˆ·è¿›è¡Œç›¸å…³æ“ä½œæ—¶å…ˆå»æŸ¥è¯¢è¯¥ç”¨æˆ·æœ‰æ²¡æœ‰è¯¥æ“ä½œçš„æƒé™ã€‚

```python
def check_permission(user,database,action):
    table = load_workbook("data/system.xlsx")['permission']
    db_list = list(iter_cols(table))[0][1:]
    row = db_list.index(database)+2
    action_list = list(iter_rows(table))[0]
    col = action_list.index(action)+1
    allow_user = table.cell(row=row, column=col).value.split(',')
    if user in allow_user:
        return True
    else:
        print "Permission not allowed"
        return False
```

## 3.12 æƒé™çš„èµ‹äºˆå’Œå›æ”¶æ¨¡å—

ä½¿ç”¨grantå’Œrevokeå…³é”®å­—èµ‹äºˆæƒé™å’Œå›æ”¶æƒé™ï¼Œå®è´¨æ˜¯å¯¹permisionè¡¨ä¸­æ•°æ®è¿›è¡Œæ›´æ–°ã€‚

**grantè¯­å¥**

```sql
grant select on test_tb for testuser
```

![](http://www.write-bug.com/myres/static/uploads/2021/10/19/38a7d9a43a91428b576aee5f32523175.writebug)

è¿™é‡Œç¬¬ä¸€åˆ—æ˜¯å…·æœ‰æƒé™çš„å¯¹è±¡ï¼Œä¸åªæ˜¯æ•°æ®åº“ï¼Œå¯ä»¥æ˜¯table,view,indexï¼Œåœ¨å‡½æ•°å¯¹åº”å‡½æ•°å¤„ç†æ—¶å°†æ•°æ®åº“åå˜é‡æ¢æˆå…¶ä»–å¯¹è±¡å°±OKã€‚

```python
def set_permission(user,database,action):
    db = load_workbook("data/system.xlsx")
    table = db['permission']
    db_list = list(iter_cols(table))[0][1:]
    row = db_list.index(database) + 2
    action_list = list(iter_rows(table))[0]
    col = action_list.index(action) + 1
    allow_user = table.cell(row=row, column=col).value.split(',')
    if user in allow_user:
        print "user have this permission"
    else:
        table.cell(row=row, column=col).value = table.cell(row=row, column=col).value + ',' + user
        db.save("data/system.xlsx")
```

**revokeè¯­å¥**

```sql
revoke select on test_tb for testuser
```

```python
def del_permission(user,database,action):
    db = load_workbook("data/system.xlsx")
    table = db['permission']
    db_list = list(iter_cols(table))[0][1:]
    row = db_list.index(database) + 2
    action_list = list(iter_rows(table))[0]
    col = action_list.index(action) + 1
    allow_user = table.cell(row=row, column=col).value.split(',')
    if user in allow_user:
        if allow_user.index(user) == 0:
            table.cell(row=row, column=col).value = table.cell(row=row, column=col).value.replace(user, '')
        else:
            table.cell(row=row, column=col).value = table.cell(row=row, column=col).value.replace(',' + user, '')
        db.save("data/system.xlsx")
    else:
        print "user didn't have this permission"
```

## 3.13 çº¦æŸæ£€æŸ¥æ¨¡å—

æ£€æŸ¥ä¸»ç ã€å¤–ç ã€å”¯ä¸€æ€§çº¦æŸã€éç©ºçº¦æŸç­‰å®Œæ•´æ€§çº¦æŸã€‚

å•ç‹¬çš„çº¦æŸæ£€æŸ¥å‡½æ•°ï¼Œåœ¨è¿›è¡Œinsert,updateç­‰æ“ä½œæ—¶ç›´æ¥è°ƒç”¨å°±OKã€‚

```python
def check_Constraint(columns,tablename):    #columns={'a':'xx'}
    db = load_workbook("system/table_information.xlsx")
    table = db[using_dbname]
    rows = []
    rows_list = list(iter_rows(table))  #æ‰€æœ‰è¡Œ
    cols_list = list(iter_cols(table))
    for col in columns:
        value = columns[col]
        for i in range(len(cols_list[0])):  #tableå¯¹åº”çš„è¡Œ
            if cols_list[0][i] == tablename:
                rows.append(i)
        for line in rows:
            if rows_list[line][1] == col:
                typee, is_null, unique, pk, fk = rows_list[line][2:]
                if is_null == '0':
                    if value == '':
                        return False
                if unique == '1':
                    if not check_unique(tablename,col,value):
                        return False
                if pk == '1':
                    if not check_unique(tablename,col,value) or value == '':
                        return False
                if '[' in typee:
                    typee, maxlen = re.findall('(\w*)\[(\d*)\]',type) #int[10] => int,10
                else:
                    maxlen = 1000
                if len(value) > maxlen:
                    return False
                if typee == 'int':
                    if type(value) != type(1):
                        return False
                if typee == 'char':
                    if type(value) != type('c'):
                        return False

def check_unique(tablename,column,value):
    table = using_db[tablename]
    col_pos = list(iter_rows(table))[0].index(column)   #ç¬¬å‡ åˆ—
    cols_list = list(iter_cols(table))[col_pos][1:]
    if cols_list.count(value) > 1:  #è¯¥åˆ—ä¸­è¯¥å€¼æ•°é‡
        return False
    else:
        return True
```

## 3.14 æŸ¥è¯¢æ¨¡å—

```python
* æ”¯æŒåµŒå¥—æŸ¥è¯¢ï¼Œand,or,in,likeè°“è¯ã€‚
* é€šè¿‡evalå‡½æ•°å¤„ç†æ¯”è¾ƒè¿ç®—å’Œæ•°å­¦è¿ç®—
* é€šè¿‡selectç­‰å…³é”®å­—ä¸ªæ•°åˆ¤æ–­å­æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢é€šè¿‡tagå‚æ•°è°ƒç”¨queryå‡½æ•°è·å¾—æŸ¥è¯¢ç»“æœæ•°ç»„
* queryå‡½æ•°ä¸­è¯­å¥çš„å¤„ç†å¾ˆå…³é”®ï¼Œé€šè¿‡ä¸€äº›å‚æ•°å‘Šè¯‰selectå‡½æ•°è¦è¿”å›ä»€ä¹ˆæ ·çš„å€¼ã€‚æå‰è®²è¯­å¥å¤„ç†æˆdictæˆ–listè®²è°“è¯ç­‰è½¬æ¢æˆç¬¦å·æ–¹ä¾¿selectå‡½æ•°çš„å¤„ç†ã€‚
* æŸ¥è¯¢æ—¶è½¬æ¢æˆæ•°ç»„æ–¹ä¾¿æ“ä½œ

    elif operate == 'select':
        pos = 0
        for i in range(len(sql_word)):
            if '(' in sql_word[i] and 'select' in sql_word[i]:
                pos = i
        if pos == 3:
            sql2 = sql_word[3][1:-1]
            query(sql2,tag='nesting')
            sql_word[3] = 'tmp'
            sql = ' '.join(sql_word)
        columns = sql_word[1]
        table_name = sql_word[3]
        if len(sql_word) > 4:
            #try:
            limit = sql_word[5].split()
            predicate = 'and'
            symbol = '='
            if ',' in sql_word[5]:
                limit = sql_word[5].split(',')
                predicate = 'and'
            elif '|' in sql_word[5]:
                limit = sql_word[5].split('|')
                predicate = 'or'
            elif '>' in sql_word[5]:
                #limit = sql_word[5].split()
                symbol = '>'
            elif '<' in sql_word[5]:
                #limit = sql_word[5].split()
                symbol = '<'
            elif len(sql_word) > 6:
                if sql_word[6] == 'in':
                    limit = [sql_word[5] + '=' + sql_word[7]]
                    predicate = 'in'
                if sql_word[6] == 'like':
                    limit = [sql_word[5] + '=' + sql_word[7]]
                    predicate = 'like'
            #except:
                #limit = [].append(sql_word[5])
            #print limit
            for i in range(len(limit)):
                limit[i] = limit[i].split(symbol)
            limit = dict(limit)
            return select(columns, table_name, limit, predicate=predicate, symbol=symbol, tag=tag)
        else:   #æ²¡whereçš„æƒ…å†µ
            return select(columns, table_name, tag=tag)
```

selectå‡½æ•°ï¼Œä¸ä»…ä»…æä¾›æŸ¥è¯¢çš„åŠŸèƒ½ï¼Œè¿˜ç”¨æ¥å¤„ç†viewçš„ä¸€éƒ¨åˆ†æ•°æ®,é€šè¿‡tagå‚æ•°æ¥æ ‡è¯†æ•°æ®å¦‚ä½•å¤„ç†ã€‚

æŸ¥è¯¢å‡½æ•°

```python
def select(columns,table_name,limit={},predicate='and', symbol='=', tag=''):    #{'c':'x','d':'x'}
    if using_dbname == '':
        print "please choose databse!"
        return
    table = using_db[table_name]
    #print columns
    if columns == '*' and len(limit) == 0:
        columns_name = list(iter_rows(table))[0]
        table_print = PrettyTable(columns_name)
        for i in range(1,len(list(iter_rows(table)))):
            table_print.add_row(list(iter_rows(table))[i])
        table_print.reversesort = True
        if tag == 'view':
            print table_print
            return list(iter_rows(table))   #view

        else:
            print(table_print)
    else:
        sel_cols = columns.split(',')   #*çš„æƒ…å†µ
        rows_list = list(iter_rows(table))  #æ‰€æœ‰çš„è¡Œ
        cols = rows_list[0]
        col_pos = []
        limit_pos = []
        print_row = []
        limit_cols = list(limit)
        symbol = '==' if symbol == '=' else symbol
        if columns[0] != '*':
            for i in range(len(sel_cols)):
                col_pos.append(cols.index(sel_cols[i])) #è¦æŸ¥çš„åˆ—çš„åˆ—å·
        else:
            sel_cols = list(iter_rows(table))[0]
            col_pos = range(len(cols))
        for i in range(len(limit)):
            limit_pos.append(cols.index(limit_cols[i])) #whereçš„åˆ—
        for i in range(1, len(rows_list)):
            match = 0
            if predicate == 'in':
                match_list = limit[limit_cols[0]]
                for j in len(match_list):
                    if rows_list[i][limit_pos[0]] == match_list[j]:
                        print_row.append(i)
            if predicate == 'like':
                like_word = re.findall('(.*)\%',limit[limit_cols[0]])
                if like_word in rows_list[i][limit_pos[0]]:
                    print_row.append(i)
            else:
                for j in range(len(limit_pos)): #é€šè¿‡evalå®ç°æ¯”è¾ƒè¿ç®—
                    if eval("'" + rows_list[i][limit_pos[j]] + "'" + symbol + "'" + limit[limit_cols[j]] + "'"):
                        match += 1
                if predicate == None:
                    print_row.append(i)
                if predicate == 'and' and match == len(limit_pos):  #andæ—¶è¦å…¨éƒ¨åŒ¹é…
                    print_row.append(i)     #ç¬¦åˆæ¡ä»¶çš„è¡Œå·
                if predicate == 'or' and match > 0: #oræ—¶è‡³å°‘ä¸€ä¸ªåŒ¹é…
                    print_row.append(i)

        table_print = PrettyTable(sel_cols)
        for i in range(len(print_row)):
            add_rows = []
            for x in col_pos:
                add_rows.append(rows_list[print_row[i]][x])
            table_print.add_row(add_rows)
        table_print.reversesort = True
        if tag == 'view':
            return table_print
        elif tag == 'nesting':
            tmpdb = using_db
            table = tmpdb['tmp']
            for i in range(len(sel_cols)):
                table.cell(row=0,column=i+1).value = sel_cols[i]
            for i in range(len(print_row)):
                add_rows = []
                for x in col_pos:
                    add_rows.append(rows_list[print_row[i]][x])
                for j in range(len(add_rows)):
                    table.cell(row=i+2,column=j+1).value = add_rows[j]
            tmpdb.save("data/" + using_dbname + ".xlsx")

        else:
            #table_print.reversesort = True
            print(table_print)
```

## 3.15 ç´¢å¼•æ¨¡å—

B+æ ‘çš„ç´¢å¼•ï¼Œå°†æ•°æ®å…ˆå¤„ç†æˆæ•°ç»„ï¼Œæ¯ä¸€ç»„æ•°æ®åŒ…å«æ•°æ®å€¼å’Œæ•°æ®åœ¨è¡¨ä¸­çš„ä½ç½®ï¼ˆèµ·åˆ°æŒ‡é’ˆçš„ä½œç”¨ï¼‰ã€‚B+æ ‘çš„å¤„ç†å•ç‹¬å†™äº†ä¸€ä¸ªç±»ï¼Œæ–¹ä¾¿è°ƒç”¨å¤„ç†ã€‚

```python
def index(current_database,table_name,column_name):
    table = current_database[table_name]
    table_columns = table.max_column
    table_rows = table.max_row
    column_num = 0
    column_value = []
    column_position = []
    for i in range(1,table_columns+1):
        if table.cell(row=1,column=i).value == column_name:
            column_num = i
    if column_num == 0:
        print "no this column"
        return
    else:
        for i in range(2,table_rows+1):
            column_value.append(str(table.cell(row=i,column=column_num).value))
            column_position.append('<{},{}>'.format(i,column_num))
    column_value.sort()
    for i in range(len(column_value)):
        tmp = [column_value[i],column_position[i]]   #like [1,aaa|<2,1>]
        column_value[i] = tuple(tmp)    #like [(1,aaa|<2,1>)]
    #print column_value[0]
    bt = test_BPTree(column_value)
    indexname = table_name + '|' +column_name
    save_index(str(bt), indexname)

def save_index(bt,indexname):
    line = re.findall(r'\[.*?\]', bt)
    for i in range(len(line)):
        line[i] = line[i][2:-2].replace('|', '')
    file = open('data/index/' + indexname,'w')
    for i in range(len(line)):
        file.writelines(line[i] + '\n')
file.close()
```

ç´¢å¼•çš„å­˜å‚¨ï¼Œå­˜å‚¨ç”Ÿæˆçš„b+æ ‘ï¼Œæ¯ä¸€è¡Œæ˜¯B+æ ‘çš„ä¸€å±‚ã€‚å­˜å‚¨æ•°æ®ç±»å‹æ˜¯å­—å…¸ã€‚

```python
def select_index(a)
	Pos = BPTree_search(a)

def update_index(table_name, column_name)
	index(using_db, table_name, column_name)
```

B+æ ‘çš„éƒ¨åˆ†ä»£ç 

```python
class BPTree(object):
â€¦
    def search(self, node, key):
        i = bisect.bisect_left(node.keys, key)
        if i < len(node.keys) and key == node.keys[i]:
            if node.is_leaf():
                return (node, i)
            else:
                return self.search(node.children[i + 1], key)
        if node.is_leaf():
            return (None, None)
        else:
            # self.disk_read(node.children[i])
            return self.search(node.children[i], key)

â€¦
    def insert(self, key, value):
        if len(self.root.keys) == self._maxkeys:
            oldroot = self.root
            self.root = BPNode()
            self.root.children.append(oldroot)
            self.split_child(self.root, 0, oldroot)
            self.insert_nonfull(self.root, key, value)
        else:
            self.insert_nonfull(self.root, key, value)
â€¦
def levels(self):
        leveldict = {}

        for level, node in self.bft(self.root):
            leveldict.setdefault(level, []).append(node)

        return leveldict

    def pprint(self, width=80):
        leveldict = self.levels()
        keys = leveldict.keys()
        for k in keys:
            print ' '.join(str(e) for e in leveldict[k]).center(width)
        return leveldict

    def min(self):
        node = self.root
        while node.children:
            node = node.children[0]
        return node.keys[0]

    def max(self):
        node = self.root
        while node.children:
            node = node.children[-1]
        return node.keys[-1]

    def bft(self, node, level=1):
        """Breadth first traversal."""
        q = Queue.Queue()
        level = level
        q.put((level, node))

        while not q.empty():
            level, node = q.get()
            yield (level, node)
            for e in node.children:
                q.put((level + 1, e))
â€¦
    def ceiling(self, node, key):
        i = bisect.bisect(node.keys, key)
        if i < len(node.keys) and key == node.keys[i]:
            if node.is_leaf():
                return key
            else:
                return self.ceiling(node.children[i + 1], key)
        if node.is_leaf():
            if i == len(node.keys):
                kp = node.keys[-1]
                if node.keys[-1] < key:
                    if len(node.next.keys) > 0:
                        return node.next.keys[0